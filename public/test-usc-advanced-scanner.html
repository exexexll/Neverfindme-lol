<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USC Card Advanced Scanner - Multi-Library Test</title>
    
    <!-- Load Multiple Barcode Libraries for Testing -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0c;
            color: white;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(135deg, #990000 0%, #FFCC00 100%);
            border-radius: 20px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .scanner-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .scanner-grid {
                grid-template-columns: 1fr;
            }
        }

        .scanner-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }

        .scanner-card h2 {
            margin-bottom: 15px;
            color: #FFCC00;
            font-size: 1.5rem;
        }

        video {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 10px;
            object-fit: cover;
        }

        .guide-overlay {
            position: relative;
            height: 300px;
            margin-bottom: 15px;
        }

        .scan-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 100px;
            border: 3px solid white;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .scan-guide.active {
            border-color: #4CAF50;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.05); }
        }

        button {
            width: 100%;
            padding: 15px;
            margin: 5px 0;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #990000;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #770000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(153, 0, 0, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .result-box {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .result-box.success {
            border-left: 5px solid #4CAF50;
        }

        .result-box.error {
            border-left: 5px solid #f44336;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            margin: 10px 0;
        }

        .info-label {
            color: #FFCC00;
            font-weight: bold;
        }

        .info-value {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .benchmark-display {
            background: linear-gradient(135deg, #4CAF50 0%, #2196F3 100%);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .benchmark-display.visible {
            display: block;
        }

        .benchmark-id {
            font-size: 3rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }

        .comparison-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-table th {
            background: rgba(255, 204, 0, 0.2);
            color: #FFCC00;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .status-badge.success {
            background: #4CAF50;
            color: white;
        }

        .status-badge.error {
            background: #f44336;
            color: white;
        }

        .tips-box {
            background: rgba(255, 204, 0, 0.1);
            border: 2px solid #FFCC00;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .tips-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .tips-box li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì USC Card Barcode Scanner</h1>
            <p style="font-size: 1.2rem; opacity: 0.9;">Advanced Multi-Library Test & Benchmark Tool</p>
        </header>

        <!-- Tips -->
        <div class="tips-box">
            <h3 style="color: #FFCC00; margin-bottom: 10px;">üí° Scanning Tips for Best Results</h3>
            <ul>
                <li><strong>Lighting:</strong> Bright, even light (avoid shadows & glare)</li>
                <li><strong>Distance:</strong> 6-12 inches from camera</li>
                <li><strong>Angle:</strong> Hold card flat, parallel to camera</li>
                <li><strong>Steadiness:</strong> Keep card still for 1-2 seconds</li>
                <li><strong>Focus:</strong> Wait for camera to auto-focus (image should be sharp)</li>
            </ul>
        </div>

        <!-- Scanner Section -->
        <div class="scanner-card">
            <h2>üì∑ Live Barcode Scanner</h2>
            
            <div class="guide-overlay">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <div id="scanGuide" class="scan-guide"></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button id="startBtn" class="btn-primary" onclick="startCamera()">
                    üì∑ Start Camera
                </button>
                <button id="stopBtn" class="btn-secondary" onclick="stopCamera()" disabled>
                    ‚èπ Stop Camera
                </button>
            </div>

            <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Status:</span>
                    <span id="scanStatus" style="font-weight: bold; color: #FFCC00;">Ready</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                    <span>Scans/sec:</span>
                    <span id="scanRate" style="font-weight: bold;">-</span>
                </div>
            </div>
        </div>

        <!-- Benchmark Section -->
        <div id="benchmarkDisplay" class="benchmark-display">
            <h2 style="font-size: 2rem; margin-bottom: 10px;">üéØ BENCHMARK USC ID</h2>
            <p style="opacity: 0.9; margin-bottom: 15px;">Reference for Valid USC Campus Cards</p>
            <div class="benchmark-id" id="benchmarkId">-</div>
            <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                <p><strong>Format:</strong> <span id="benchmarkFormat">-</span></p>
                <p><strong>Scanned:</strong> <span id="benchmarkTime">-</span></p>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="results-panel">
            <h2 style="margin-bottom: 20px; font-size: 2rem;">üìä Scan Results & Analysis</h2>

            <!-- Current Scan -->
            <div id="currentScan" class="result-box">
                <p style="opacity: 0.6; text-align: center; padding: 20px;">
                    Waiting for scan... Hold your USC card's barcode in the camera view.
                </p>
            </div>

            <!-- Validation Details -->
            <div id="validationDetails" style="display: none;"></div>

            <!-- Statistics Table -->
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Total Attempts</td>
                        <td id="statTotal">0</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>Valid USC IDs</td>
                        <td id="statValid">0</td>
                        <td><span id="statValidBadge" class="status-badge success">0%</span></td>
                    </tr>
                    <tr>
                        <td>Invalid Scans</td>
                        <td id="statInvalid">0</td>
                        <td><span id="statInvalidBadge" class="status-badge error">0%</span></td>
                    </tr>
                    <tr>
                        <td>Success Rate</td>
                        <td id="statRate">-</td>
                        <td id="statRateStatus">-</td>
                    </tr>
                </tbody>
            </table>

            <!-- Recent Scans -->
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px; color: #FFCC00;">üìú Recent Scans (Last 5)</h3>
                <div id="recentScans" style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; min-height: 100px;">
                    <p style="opacity: 0.5; text-align: center;">No scans yet</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== BARCODE DETECTION USING ZXING =====
        const { BrowserMultiFormatReader, BarcodeFormat } = ZXing;
        
        let codeReader = null;
        let videoStream = null;
        let isScanning = false;
        let scanInterval = null;
        
        // Stats
        let totalScans = 0;
        let validScans = 0;
        let invalidScans = 0;
        let recentScans = [];
        
        // Benchmark
        let benchmarkUSCId = null;
        let benchmarkFormat = null;
        
        // Consecutive reads for validation
        let consecutiveReads = [];
        const REQUIRED_CONSECUTIVE = 3;
        
        // ===== USC ID EXTRACTION & VALIDATION =====
        function extractUSCId(rawText) {
            console.log('[Extract] Input:', rawText);
            
            // Remove all non-digits
            const digits = rawText.replace(/\D/g, '');
            
            // USC ID is exactly 10 digits
            if (digits.length === 10) {
                return digits;
            }
            
            // If longer, try to find 10-digit sequence
            // Example: "USC1268306021" or "12683060215156"
            const matches = digits.match(/(\d{10})/g);
            if (matches && matches.length > 0) {
                // Return first 10-digit match
                return matches[0];
            }
            
            return null;
        }
        
        function validateUSCId(uscId) {
            const validations = [];
            let isValid = true;
            
            // 1. Length check
            const lengthOK = uscId && uscId.length === 10;
            validations.push({
                test: 'Length',
                pass: lengthOK,
                expected: '10 digits',
                actual: uscId ? `${uscId.length} digits` : 'null',
            });
            if (!lengthOK) isValid = false;
            
            // 2. Format check (all numeric)
            const formatOK = /^[0-9]{10}$/.test(uscId || '');
            validations.push({
                test: 'Format',
                pass: formatOK,
                expected: 'All numeric',
                actual: formatOK ? '‚úì Numeric' : '‚úó Contains non-digits',
            });
            if (!formatOK) isValid = false;
            
            // 3. Range check
            const num = parseInt(uscId || '0');
            const rangeOK = num >= 1000000000 && num <= 9999999999;
            validations.push({
                test: 'Range',
                pass: rangeOK,
                expected: '1000000000 - 9999999999',
                actual: num.toLocaleString(),
            });
            if (!rangeOK) isValid = false;
            
            // 4. First digit check (USC IDs likely start with 1 or 2)
            const firstDigit = uscId ? uscId[0] : '0';
            const firstDigitOK = firstDigit === '1' || firstDigit === '2';
            validations.push({
                test: 'First Digit',
                pass: firstDigitOK,
                expected: '1 or 2',
                actual: firstDigit,
            });
            // Don't fail on this - just informational
            
            // 5. Benchmark comparison (if set)
            if (benchmarkUSCId) {
                const matchesBenchmark = uscId === benchmarkUSCId;
                validations.push({
                    test: 'Benchmark Match',
                    pass: matchesBenchmark,
                    expected: benchmarkUSCId,
                    actual: uscId,
                });
                // Don't fail - just for comparison
            }
            
            return {
                isValid,
                uscId,
                validations,
            };
        }
        
        // ===== CAMERA & SCANNING =====
        async function startCamera() {
            try {
                document.getElementById('scanStatus').textContent = 'Initializing camera...';
                
                document.getElementById('scanGuide').classList.add('active');
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                // Let ZXing handle camera initialization completely
                // It will request camera and start video automatically
                startBarcodeDetection();
                
                console.log('‚úÖ Starting ZXing camera...');
            } catch (err) {
                console.error('‚ùå Camera error:', err);
                document.getElementById('scanStatus').textContent = 'Camera error';
                alert(`Camera Error: ${err.message}\n\nPlease allow camera permission.`);
            }
        }
        
        async function stopCamera() {
            // Stop ZXing scanner
            if (codeReader) {
                try {
                    await codeReader.reset();
                    console.log('‚úÖ ZXing scanner stopped');
                } catch (err) {
                    console.warn('Error stopping scanner:', err);
                }
                codeReader = null;
            }
            
            // Stop camera
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            const video = document.getElementById('video');
            video.srcObject = null;
            
            document.getElementById('scanGuide').classList.remove('active');
            document.getElementById('scanStatus').textContent = 'Camera stopped';
            document.getElementById('scanRate').textContent = '-';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            isScanning = false;
            consecutiveReads = [];
            
            console.log('‚èπ Camera stopped');
        }
        
        async function startBarcodeDetection() {
            codeReader = new BrowserMultiFormatReader();
            
            console.log('üîç ZXing BrowserMultiFormatReader initialized');
            console.log('üìπ Starting continuous decode from video...');
            
            // Configure video constraints
            const constraints = {
                video: {
                    facingMode: 'environment', // Back camera
                    width: { ideal: 1920, min: 1280 },
                    height: { ideal: 1080, min: 720 },
                }
            };
            
            try {
                // ZXing handles everything: camera request, video start, and continuous scanning
                await codeReader.decodeFromConstraints(
                    constraints,
                    'video', // Video element ID
                    (result, error) => {
                        if (result) {
                            // Success - barcode detected
                            console.log('üìä Barcode detected:', result.text);
                            handleBarcodeDetected(result);
                        }
                        // Errors are normal when no barcode in view
                        // Don't log NotFoundException spam
                    }
                );
                
                isScanning = true;
                document.getElementById('scanStatus').textContent = 'üîç Scanning for barcodes...';
                console.log('‚úÖ ZXing continuous scanning started');
                
            } catch (err) {
                console.error('‚ùå ZXing scan error:', err);
                document.getElementById('scanStatus').textContent = 'Scanner error: ' + err.message;
                alert(`Scanner Error: ${err.message}\n\nPlease allow camera permission and try again.`);
                
                // Re-enable start button
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }
        
        // ===== BARCODE DETECTION HANDLER =====
        function handleBarcodeDetected(result) {
            const rawText = result.text;
            const format = BarcodeFormat[result.format] || 'Unknown';
            
            console.log('‚îÅ'.repeat(80));
            console.log('üéØ BARCODE DETECTED');
            console.log('Raw Text:', rawText);
            console.log('Format:', format);
            console.log('‚îÅ'.repeat(80));
            
            // Multi-read validation
            consecutiveReads.push(rawText);
            if (consecutiveReads.length > REQUIRED_CONSECUTIVE) {
                consecutiveReads.shift();
            }
            
            document.getElementById('scanStatus').textContent = 
                `Reading... (${consecutiveReads.length}/${REQUIRED_CONSECUTIVE})`;
            
            // Check if we have 3 consecutive identical reads
            if (consecutiveReads.length === REQUIRED_CONSECUTIVE) {
                const allMatch = consecutiveReads.every(r => r === consecutiveReads[0]);
                
                if (allMatch) {
                    console.log('‚úÖ CONFIRMED: 3 consecutive identical reads');
                    processValidatedScan(rawText, format);
                    consecutiveReads = []; // Reset
                    
                    // Visual feedback
                    document.getElementById('scanGuide').style.borderColor = '#4CAF50';
                    setTimeout(() => {
                        document.getElementById('scanGuide').style.borderColor = 'white';
                    }, 500);
                }
            }
        }
        
        function processValidatedScan(rawText, format) {
            totalScans++;
            
            // Extract USC ID
            const uscId = extractUSCId(rawText);
            
            // Validate
            const validation = validateUSCId(uscId);
            
            // Display results
            if (validation.isValid) {
                validScans++;
                displayValidScan(rawText, uscId, format, validation);
                
                // Set as benchmark if first valid scan
                if (!benchmarkUSCId) {
                    setBenchmark(uscId, format);
                }
                
                // Audio feedback
                playSuccessBeep();
            } else {
                invalidScans++;
                displayInvalidScan(rawText, uscId, format, validation);
            }
            
            // Update stats
            updateStatistics();
            
            // Add to recent scans
            addToRecentScans({
                time: new Date(),
                raw: rawText,
                uscId: uscId,
                format: format,
                valid: validation.isValid,
            });
        }
        
        // ===== DISPLAY FUNCTIONS =====
        function displayValidScan(raw, uscId, format, validation) {
            const container = document.getElementById('currentScan');
            container.className = 'result-box success';
            
            container.innerHTML = `
                <h3 style="color: #4CAF50; font-size: 1.8rem; margin-bottom: 15px;">
                    ‚úÖ VALID USC CAMPUS CARD
                </h3>
                
                <div class="info-grid">
                    <div class="info-label">USC ID:</div>
                    <div class="info-value" style="font-size: 1.5rem; color: #4CAF50; font-weight: bold;">
                        ${uscId}
                    </div>
                    
                    <div class="info-label">Raw Barcode:</div>
                    <div class="info-value">${raw}</div>
                    
                    <div class="info-label">Format:</div>
                    <div class="info-value">${format}</div>
                    
                    <div class="info-label">Timestamp:</div>
                    <div class="info-value">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            
            showValidationDetails(validation.validations, true);
        }
        
        function displayInvalidScan(raw, uscId, format, validation) {
            const container = document.getElementById('currentScan');
            container.className = 'result-box error';
            
            container.innerHTML = `
                <h3 style="color: #f44336; font-size: 1.8rem; margin-bottom: 15px;">
                    ‚ùå INVALID SCAN
                </h3>
                
                <div class="info-grid">
                    <div class="info-label">Raw Barcode:</div>
                    <div class="info-value">${raw}</div>
                    
                    ${uscId ? `
                        <div class="info-label">Extracted ID:</div>
                        <div class="info-value" style="color: #f44336;">${uscId}</div>
                    ` : ''}
                    
                    <div class="info-label">Format:</div>
                    <div class="info-value">${format}</div>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: rgba(244, 67, 54, 0.2); border-radius: 8px;">
                    <strong>‚ö†Ô∏è This is NOT a valid USC campus card barcode</strong>
                </div>
            `;
            
            showValidationDetails(validation.validations, false);
        }
        
        function showValidationDetails(checks, isValid) {
            const container = document.getElementById('validationDetails');
            container.style.display = 'block';
            
            let html = `
                <div style="margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <h4 style="margin-bottom: 15px; color: #FFCC00;">üîç Validation Checks</h4>
            `;
            
            checks.forEach(check => {
                const icon = check.pass ? '‚úÖ' : '‚ùå';
                html += `
                    <div style="display: flex; gap: 15px; padding: 10px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 5px;">
                        <span style="font-size: 1.3rem;">${icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: bold;">${check.test}</div>
                            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 3px;">
                                Expected: ${check.expected} ‚Üí Got: ${check.actual}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }
        
        function setBenchmark(uscId, format) {
            benchmarkUSCId = uscId;
            benchmarkFormat = format;
            
            document.getElementById('benchmarkDisplay').classList.add('visible');
            document.getElementById('benchmarkId').textContent = uscId;
            document.getElementById('benchmarkFormat').textContent = format;
            document.getElementById('benchmarkTime').textContent = new Date().toLocaleString();
            
            console.log('üéØ BENCHMARK SET:', { uscId, format });
            
            // Save to localStorage for persistence
            localStorage.setItem('usc_benchmark_id', uscId);
            localStorage.setItem('usc_benchmark_format', format);
            
            // Alert user
            setTimeout(() => {
                alert(`üéØ BENCHMARK SET!\n\nUSC ID: ${uscId}\nFormat: ${format}\n\nThis will be used as the reference for all valid USC cards.`);
            }, 100);
        }
        
        function updateStatistics() {
            document.getElementById('statTotal').textContent = totalScans;
            document.getElementById('statValid').textContent = validScans;
            document.getElementById('statInvalid').textContent = invalidScans;
            
            const successRate = totalScans > 0 ? ((validScans / totalScans) * 100).toFixed(1) : '0';
            document.getElementById('statRate').textContent = successRate + '%';
            
            // Update badges
            document.getElementById('statValidBadge').textContent = 
                totalScans > 0 ? ((validScans / totalScans) * 100).toFixed(0) + '%' : '0%';
            document.getElementById('statInvalidBadge').textContent = 
                totalScans > 0 ? ((invalidScans / totalScans) * 100).toFixed(0) + '%' : '0%';
            
            // Color code success rate
            const rateStatus = document.getElementById('statRateStatus');
            if (successRate >= 80) {
                rateStatus.textContent = 'üü¢ Excellent';
                rateStatus.style.color = '#4CAF50';
            } else if (successRate >= 50) {
                rateStatus.textContent = 'üü° Good';
                rateStatus.style.color = '#FFCC00';
            } else {
                rateStatus.textContent = 'üî¥ Poor';
                rateStatus.style.color = '#f44336';
            }
        }
        
        function addToRecentScans(scan) {
            recentScans.unshift(scan);
            if (recentScans.length > 5) {
                recentScans.pop();
            }
            
            const container = document.getElementById('recentScans');
            let html = '';
            
            recentScans.forEach((s, i) => {
                const icon = s.valid ? '‚úÖ' : '‚ùå';
                const color = s.valid ? '#4CAF50' : '#f44336';
                html += `
                    <div style="padding: 12px; margin: 8px 0; background: rgba(255,255,255,0.05); border-left: 3px solid ${color}; border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold;">${icon} ${s.uscId || 'Invalid'}</span>
                            <span style="font-size: 0.85rem; opacity: 0.7;">${s.time.toLocaleTimeString()}</span>
                        </div>
                        <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 5px;">
                            Format: ${s.format} ‚Ä¢ Raw: ${s.raw.substring(0, 30)}${s.raw.length > 30 ? '...' : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function playSuccessBeep() {
            // Create audio context for beep
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800; // Hz
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (err) {
                // Audio not critical
                console.log('Could not play audio:', err);
            }
        }
        
        // ===== INITIALIZE =====
        window.addEventListener('load', () => {
            console.log('üéì USC Card Scanner Test Loaded');
            console.log('üì± Ready to scan');
            
            // Load benchmark from localStorage if exists
            const savedBenchmark = localStorage.getItem('usc_benchmark_id');
            const savedFormat = localStorage.getItem('usc_benchmark_format');
            
            if (savedBenchmark) {
                benchmarkUSCId = savedBenchmark;
                benchmarkFormat = savedFormat;
                
                document.getElementById('benchmarkDisplay').classList.add('visible');
                document.getElementById('benchmarkId').textContent = benchmarkUSCId;
                document.getElementById('benchmarkFormat').textContent = benchmarkFormat || 'Unknown';
                
                console.log('üìÇ Loaded benchmark from localStorage:', benchmarkUSCId);
            }
            
            updateStatistics();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>
</html>

